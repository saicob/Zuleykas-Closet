<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles.css">
    <title>Informe de Ventas</title>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">

    <!-- jQuery y DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <style>
        #Detalles-Venta {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(209, 106, 138, 0.13);
            padding: 28px 32px 18px 32px !important;
            max-width: 800px;
            border-top: 5px solid #f8a8b9;
        }

        #Detalles-Venta h2 {
            font-family: 'Montserrat', Arial, sans-serif;
            font-size: 2rem !important;
            color: #d16a8a;
            margin-bottom: 8px;
            font-weight: 800;
            letter-spacing: 1px;
        }

        #Detalles-Venta h3 {
            color: #a07a8c;
            font-size: 1.1rem;
            margin-bottom: 8px;
            font-weight: 700;
        }

        #info-factura {
            color: #888;
            font-size: 1.01rem;
            margin-bottom: 18px;
        }

        #Detalles-Venta strong {
            color: #d16a8a;
            font-weight: 600;
        }

        #Detalles-Venta table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(209, 106, 138, 0.07);
            margin-bottom: 10px;
        }

        #Detalles-Venta th {
            background: #f8e8ee;
            color: #a07a8c;
            font-weight: 700;
            font-size: 1.01rem;
            border: 1px solid #e0bfc7 !important;
        }

        #Detalles-Venta td {
            background: #fff;
            color: #333;
            border: 1px solid #e0bfc7 !important;
            font-size: 0.98rem;
        }

        #Cerrar-Detalles {
            background: #f8a8b9;
            
            border: none;
            border-radius: 8px;
            padding: 10px 28px;
            font-size: 1.08rem;
            
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(248, 168, 185, 0.08);
            transition: background 0.18s;
        }

        #Cerrar-Detalles:hover {
            background: #d16a8a;
        }
    </style>
</head>

<body>
    <section id="menú" style="position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: white;">
        <div class="rectangle">
            <header class="top-menu">
                <div class="logo">
                    <img src="/Zuleykas _Closet_logo.jpg" alt="Zuleyka's Closet Logo" style="height: 80px;">
                </div>
                <nav class="menu">
                    <ul>
                        <li class="dropdown">
                            <a href="#">Productos</a>
                            <ul class="dropdown-content">
                                <li><a href="VerProductos.html">Lista de Productos</a></li>
                                <li><a href="Marcas.html">Marcas</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="Proveedor.html" class="menu-button">Proveedores</a>
                        </li>
                        <li class="dropdown">
                            <a href="#">Ventas</a>
                            <ul class="dropdown-content">
                                <li><a href="Informe_de_Ventas.html">Informe de Ventas</a></li>
                                <li><a href="Rentabilidad.html">Rentabilidad</a></li>
                                <li><a href="Crear_venta.html">Crear Venta</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="Respaldo.html" class="menu-button">Respaldo</a>
                        </li>
                    </ul>
                </nav>
                <button class="logout-button">Cerrar Sesión</button>
            </header>
        </div>
        <div class="section-title-container">
            <div class="section-title">Informe de Ventas</div>
        </div>
        <h1 class="outside-title">Zuleyka's Closet</h1>
        <p class="description-text"> En este apartado podrá visualizar el informe de ventas. Podrá filtrar por fecha y
            ver el total de ventas realizadas en un periodo específico.</p>
    </section>

    <!-- Contenido central -->
    <main style="margin-top: 350px; padding: 20px;">
        <section id="informe-ventas">
            <div style="overflow-x: auto;">
                <table id="ventas-table" class="display"
                    style="width: 100%; min-width: 600px; border-collapse: collapse; background-color: white; box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25); border-radius: 16px; overflow: hidden;">
                    <thead style="background-color: #f9f9f9; border-bottom: 2px solid #ddd;">
                        <tr>
                            <th style="padding: 10px; text-align: left;">Numero de Venta</th>
                            <th style="padding: 10px; text-align: left;">Fecha</th>
                            <th style="padding: 10px; text-align: left;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="ventas-body" style="background-color: white; color: #333;">
                        <!-- Aquí se llenarán los datos de las ventas -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Modal para mostrar detalles de la venta -->
        <section id="Detalles-Venta"
            style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); z-index: 1000; border-radius: 16px; width: 90vw; max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <h2 style="font-family: 'Great Vibes', cursive; font-size: 24px; text-align: center; margin-bottom: 10px;">
                Detalles de la Venta</h2>
            <p style="text-align: center; font-size: 14px; margin-bottom: 20px;" id="info-factura">Información detallada
                de la factura</p>

            <div style="margin-bottom: 20px;">
                <h3 style="color: #dd9cba; margin-bottom: 10px;">Información de la Factura</h3>
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <strong>Número de Factura:</strong>
                        <p id="numero-factura">-</p>
                    </div>
                    <div>
                        <strong>Fecha:</strong>
                        <p id="fecha-factura">-</p>
                    </div>
                    <div>
                        <strong>Total:</strong>
                        <p id="total-factura">-</p>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="color: #dd9cba; margin-bottom: 10px;">Productos Vendidos</h3>
                <div style="overflow-x: auto;">
                    <table id="productos-factura-table"
                        style="width: 100%; min-width: 600px; border-collapse: collapse; background-color: white; border: 1px solid #ddd;">
                        <thead style="background-color: #f9f9f9;">
                            <tr>
                                <th style="padding: 8px; border: 1px solid #ddd;">Producto</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Categoría</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Marca</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Cantidad</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Precio Unit.</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="productos-factura-body">
                            <!-- Aquí se llenarán los productos de la factura -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div style="display: flex; justify-content: center; margin-top: 20px;">
                <button type="button" id="Cerrar-Detalles"
                    style="background-color: #f5f5f5; border: 1px solid #ddd; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Cerrar</button>
            </div>
        </section>

        <div id="overlay-detalles"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999;">
        </div>
    </main>

    <script src="/script.js"></script>
    <script>
        $(document).ready(function () {
            const detallesVentaSection = $('#Detalles-Venta');
            const overlayDetalles = $('#overlay-detalles');

            // Inicializar DataTable
            const table = $('#ventas-table').DataTable({
                scrollX: true,
                scrollY: "400px",
                scrollCollapse: true,
                responsive: true,
                ajax: {
                    url: 'http://localhost:3000/api/ventas',
                    dataSrc: ''
                },
                columns: [
                    { data: 'codigo_factura', title: 'Número de Venta' },
                    {
                        data: 'fecha',
                        render: function (data) {
                            const date = new Date(data);
                            return date.toLocaleDateString('es-ES', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                        }
                    },
                    {
                        data: 'total',
                        render: function (data) {
                            return `$${parseFloat(data).toFixed(2)}`;
                        }
                    }
                ],
                language: {
                    search: "Buscar:",
                    lengthMenu: "Mostrar _MENU_ registros",
                    info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
                    paginate: {
                        first: "Primero",
                        last: "Último",
                        next: "Siguiente",
                        previous: "Anterior"
                    }
                },
                error: function (xhr, error, thrown) {
                    console.error('Error al cargar los datos:', error, thrown);
                }
            });

            // Manejar clic en fila para mostrar detalles
            $('#ventas-table tbody').on('click', 'tr', async function () {
                const data = table.row(this).data();
                if (data) {
                    try {
                        const response = await fetch(`http://localhost:3000/api/factura/detalles/${data.codigo_factura}`);
                        if (response.ok) {
                            const detalles = await response.json();

                            // Llenar información de la factura
                            $('#numero-factura').text(detalles.factura.codigo_factura);
                            $('#fecha-factura').text(new Date(detalles.factura.fecha).toLocaleDateString('es-ES', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            }));
                            $('#total-factura').text(`$${parseFloat(detalles.factura.total).toFixed(2)}`);

                            // Llenar tabla de productos
                            const productosBody = $('#productos-factura-body');
                            productosBody.empty();

                            detalles.productos.forEach(producto => {
                                const row = `
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${producto.nombre}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${producto.categoria}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${producto.marca || 'Sin marca'}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${producto.cantidad}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${parseFloat(producto.precio_unitario).toFixed(2)}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${parseFloat(producto.subtotal).toFixed(2)}</td>
                                    </tr>
                                `;
                                productosBody.append(row);
                            });

                            // Mostrar el modal
                            detallesVentaSection.show();
                            overlayDetalles.show();
                        } else {
                            alert('Error al obtener los detalles de la venta');
                        }
                    } catch (error) {
                        console.error('Error al obtener detalles de la venta:', error);
                        alert('Error al cargar los detalles de la venta');
                    }
                }
            });

            // Cerrar modal de detalles
            $('#Cerrar-Detalles').on('click', function () {
                detallesVentaSection.hide();
                overlayDetalles.hide();
            });

            // Cerrar modal al hacer clic en el overlay
            overlayDetalles.on('click', function () {
                detallesVentaSection.hide();
                overlayDetalles.hide();
            });
        });
    </script>
</body>

</html>